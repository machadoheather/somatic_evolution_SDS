---
title: "analyses_mutsigmixedmodel_10samples_buccal"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE, fig.path="./graphics/plot",autodep=TRUE,fig.width=5, fig.height=4)
library(ggplot2)
library(cowplot)
library(caTools)
library(reshape2)
library(dplyr)
library(hdp)
library(RColorBrewer)
library(grid)
library(gridExtra)
library(ggpubr)
```

# Mutation burden by age and cell type: mixed effects model regression
## loading results of hdp signature analysis (no priors)
```{r, message=FALSE, warning=FALSE}
groupname = "SDS_10samples_buccal"
burden = read.table("../data/burden_by_sample.txt", header=T, stringsAsFactors = F, sep="\t")
load(file="../data/exposures_SDS10_allSDS8_buccal.sigfit.chain1.Rdata")
sig_prop = exposures$mean
sig_prop$colony = rownames(sig_prop)
sig_prop_type = merge(burden, sig_prop, by="colony")
```

# SDS ONLY
##  mixed effects model regression
```{r, message=FALSE, warning=FALSE}
library(nlme)
m3Allsub = subset(sig_prop_type, !(internal_id %in%  "SDS8") )
full.lymph.Age.lme <- lme(fixed = SBS1 ~ age_at_sample_exact, 
                            random = ~ 1 | internal_id, 
                            data = m3Allsub, method="ML")
summary(full.lymph.Age.lme)$tTable
```




## testing significance of random effects & heteroscedasticity 
```{r, message=FALSE, warning=FALSE}
## REMOVE random effect of donor? Does not run: 
# Error in getGroups.data.frame(dataMix, groups) : 
#   invalid formula for groups
full.lymph.no.within.donor.celltype.variance.lme <- lme(fixed = SBS1 ~ age_at_sample_exact, 
                            #random = ~ 1 | internal_id , 
                            data = m3Allsub, method="ML")
anova(full.lymph.Age.lme, full.lymph.no.within.donor.celltype.variance.lme, test=TRUE)
```

```{r, message=FALSE, warning=FALSE}
# full.lymph.no.between.celltype.heteroscedasticity.lme <- lme(fixed = SBS1 ~ age_at_sample_exact , 
#                             random = ~ 1 | internal_id / Cell.type2, 
#                             data = m3Allsub, method="ML")
# anova(full.lymph.Age.lme, full.lymph.no.between.celltype.heteroscedasticity.lme, test=TRUE)
# anova(full.lymph.Age.lme, full.lymph.no.between.celltype.heteroscedasticity.lme, test=TRUE)[2,9]
```

## final model
```{r, message=FALSE, warning=FALSE}
summary(full.lymph.Age.lme)
```

## intervals
```{r, message=FALSE, warning=FALSE}
intervals(full.lymph.Age.lme, which = "fixed")
```


## Calculating expected proportion for age 25 (SDS8)
```{r, message=FALSE, warning=FALSE}
#                           lower        est.        upper
# (Intercept)          0.37722847  0.44048536  0.503742241
# age_at_sample_exact -0.01581667 -0.01273071 -0.009644742
#y=-0.01273071x + 0.44048536
-0.01273071*25 + 0.44048536
# 0.1222176

summary(subset(sig_prop_type, internal_id =="SDS8")$SBS1)  
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.3718  0.3900  0.4111  0.4077  0.4199  0.4513 

t.test(subset(sig_prop_type, internal_id =="SDS8")$SBS1, alternative = "two.sided", mu =  0.1222176)
# t = 35.441, df = 9, p-value = 5.605e-11
# alternative hypothesis: true mean is not equal to 0.1222176
# 95 percent confidence interval:
#  0.3895057 0.4259532
# sample estimates:
# mean of x 
# 0.4077294 
```

## per cell subset, extract slopes and intercepts (with CIs)
```{r, message=FALSE, warning=FALSE}
# mycelltypes = c( "HSC", "Naive B", "Memory B", "Naive T",  "Memory T")
# myintercepts = myslopes = data.frame()
# for (i in 1:5){
#   m3Allsub_naiveB = m3Allsub
# m3Allsub_naiveB$Cell.type2 = factor(m3Allsub_naiveB$Cell.type2, levels=c(mycelltypes[i],mycelltypes[!(1:5 %in% i)]) )
# full.lymph.Age_cell.interaction.lme_naiveB <- lme(fixed = SBS1 ~ age_at_sample_exact * Cell.type2, 
#                             random = ~ 1 | internal_id / Cell.type2, 
#                             weights = varIdent(form= ~ 1 | Cell.type2),
#                             data = m3Allsub_naiveB, method="ML")
# myfixed = intervals(full.lymph.Age_cell.interaction.lme_naiveB)$fixed
# myintercepts[i,1:3] = myfixed[1,]
# myslopes[i,1:3] = myfixed[2,]
# }
# colnames(myslopes) = colnames(myintercepts) = c("lower", "est.","upper")
# rownames(myslopes) = rownames(myintercepts) = mycelltypes
#write.table(myintercepts, file="myintercepts.txt", quote=F, sep="\t")
#write.table(myslopes, file="myslopes.txt", quote=F, sep="\t")
myintercepts = intervals(full.lymph.Age.lme)$fixed[1,]
myslopes = intervals(full.lymph.Age.lme)$fixed[2,]
```

## Intercepts relative to HSPCs
```{r, message=FALSE, warning=FALSE}
#myintercepts-myintercepts["HSC","est."]
```

## plots showing raw data and fitted lines
```{r, message=FALSE, warning=FALSE}
#colorCodesSet2=c("HSC"="#31a354", "Naive B"="#e78ac3", "Memory B"="#fc8d62", "Naive T"="#8da0cb", "Memory T"="#8856a7","Treg" = "#d9d9d9")
mycol = brewer.pal(10, "Paired")
mycol2 = c(mycol,"black")

m3Allsub2 = rbind(subset(burden_normal, Cell.type2 == "SDS" ),
      subset(burden_normal, internal_id == "CB001")[sample(1:sum(burden_normal$internal_id == "CB001"), replace=FALSE, size=50) , ],
      subset(burden_normal, internal_id == "KX001")[sample(1:sum(burden_normal$internal_id == "CB001"), replace=FALSE, size=50) , ],
      subset(burden_normal, internal_id == "KX002")[sample(1:sum(burden_normal$internal_id == "CB001"), replace=FALSE, size=50) , ]
)
m3Allsub2$Patient = m3Allsub2$internal_id
m3Allsub2$Patient[m3Allsub2$Cell.type2=="normal"] = "normal"
m3Allsub2$Patient = factor(m3Allsub2$Patient, levels=unique(m3Allsub2$Patient) )
m3AllsubShuff = m3Allsub2[sample(1:nrow(m3Allsub2), size=nrow(m3Allsub2)),]
write.table(m3AllsubShuff, file="m3AllsubShuff.txt", col.names=T, row.names=F, quote=F, sep="\t")

mut_median_age_cell = aggregate(x=m3Allsub2$SBS1,by=list(m3Allsub2$age_at_sample_exact,m3Allsub2$Cell.type2,m3Allsub2$Patient),FUN=median)
colnames(mut_median_age_cell) = c("age_at_sample_exact","Cell.type2", "Patient","medianN")
my_slope= myslopes[2]
my_yint = myintercepts[2]
 
ggplot(m3AllsubShuff, aes(age_at_sample_exact, SBS1, color=Patient))+
  geom_point(shape=1, size=1)+
  scale_color_manual("", values=mycol2)+
  #scale_shape_manual("", values=c(1,19))+
  xlab("Age")+
  ylab("SNVs / cell")+
  geom_abline(intercept=my_yint, slope=my_slope, col="#1F78B4")+
  geom_crossbar(data=mut_median_age_cell, aes(x=age_at_sample_exact, ymin=medianN, ymax=medianN, y=medianN), width = 2, fatten = 1, col="black") +
  theme_bw()+
  #guides(colour = guide_legend(override.aes = list(size=1.5)))+
  theme(#legend.text=element_text(size=X),
        legend.key.size = unit(0.35, 'cm'))
ggsave(file=paste("figures/mutburden_SNV_byAge_scatterplot_mixedmodel_normal_", groupname, ".pdf", sep=""), width=4.5, height=3)

```


